extends ../../layout/admin.pug

block content
  div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8")
    
    // Header
    div(class="mb-8")
      a(href="/admin/pedidos" class="text-orange-600 hover:text-orange-700 font-medium text-sm mb-4 inline-flex items-center")
        | ← Volver a Pedidos
      h1(class="text-3xl font-bold text-gray-900") Pedido ##{pedido.id}
    
    div(class="grid grid-cols-1 lg:grid-cols-3 gap-8")
      
      // Contenido principal
      div(class="lg:col-span-2 space-y-6")
        
        // Información del cliente
        div(class="bg-white rounded-xl shadow-md p-6")
          h2(class="text-xl font-bold text-gray-900 mb-6") Información del Pedido
          
          div(class="grid grid-cols-1 md:grid-cols-2 gap-6")
            div
              p(class="text-sm text-gray-600 font-medium uppercase tracking-wide mb-2") Cliente
              p(class="text-lg font-semibold text-gray-900")= pedido.usuario.nombre
              p(class="text-gray-600")= pedido.usuario.email
            
            div
              p(class="text-sm text-gray-600 font-medium uppercase tracking-wide mb-2") Fecha del Pedido
              p(class="text-lg font-semibold text-gray-900")
                = new Date(pedido.fecha_creacion).toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' })
            
            div(class="md:col-span-2")
              p(class="text-sm text-gray-600 font-medium uppercase tracking-wide mb-2") Dirección de Envío
              p(class="text-gray-900")= pedido.direccion_envio
            
            div
              p(class="text-sm text-gray-600 font-medium uppercase tracking-wide mb-2") Método de Pago
              p(class="text-gray-900")
                if pedido.metodo_pago === 'contra_entrega'
                  | Contra Entrega
                else if pedido.metodo_pago === 'tarjeta'
                  | Tarjeta de Crédito
                else if pedido.metodo_pago === 'transferencia'
                  | Transferencia Bancaria
                else
                  = pedido.metodo_pago
        
        // Productos
        div(class="bg-white rounded-xl shadow-md overflow-hidden")
          div(class="bg-orange-50 px-6 py-4 border-b border-orange-200")
            h2(class="text-lg font-bold text-gray-900") Productos Ordenados
          
          div(class="overflow-x-auto")
            table(class="w-full")
              thead(class="bg-gray-50 border-b border-gray-200")
                tr
                  th(class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase") Producto
                  th(class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase") Cantidad
                  th(class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase") Precio Unitario
                  th(class="px-6 py-4 text-right text-xs font-bold text-gray-700 uppercase") Subtotal
              tbody(class="divide-y divide-gray-200")
                each item in items
                  tr(class="hover:bg-gray-50 transition")
                    td(class="px-6 py-4")
                      div(class="flex items-center gap-3")
                        if item.Producto && item.Producto.imagen_principal
                          img(src=item.Producto.imagen_principal alt=item.Producto.nombre class="w-12 h-12 object-cover rounded")
                        else
                          div(class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center")
                            span(class="text-gray-400 text-xs") Sin imagen
                        if item.Producto
                          span(class="font-medium text-gray-900")= item.Producto.nombre
                        else
                          span(class="font-medium text-gray-500") Producto no disponible
                    td(class="px-6 py-4 text-center")
                      p(class="font-medium text-gray-900")= item.cantidad
                    td(class="px-6 py-4 text-center")
                      p(class="font-medium text-gray-900") $#{Math.trunc(item.precio_unitario).toLocaleString('es-CO')}
                    td(class="px-6 py-4 text-right")
                      p(class="font-bold text-orange-600") $#{Math.trunc(item.subtotal).toLocaleString('es-CO')}
      
      // Sidebar - Cambiar estado
      div(class="lg:col-span-1")
        
        // Card de cambio de estado
        div(class="bg-white rounded-xl shadow-md p-6 sticky top-6")
          h2(class="text-lg font-bold text-gray-900 mb-6") Gestionar Pedido
          
          // Estado actual
          div(class="mb-6")
            p(class="text-sm text-gray-600 font-medium uppercase tracking-wide mb-3") Estado Actual
            div
              if pedido.estado === 'pendiente'
                span(class="inline-block px-4 py-2 rounded-lg text-sm font-semibold bg-yellow-100 text-yellow-800") Pendiente
              else if pedido.estado === 'pagado'
                span(class="inline-block px-4 py-2 rounded-lg text-sm font-semibold bg-blue-100 text-blue-800") Pagado
              else if pedido.estado === 'enviado'
                span(class="inline-block px-4 py-2 rounded-lg text-sm font-semibold bg-green-100 text-green-800") Enviado
              else if pedido.estado === 'cancelado'
                span(class="inline-block px-4 py-2 rounded-lg text-sm font-semibold bg-red-100 text-red-800") Cancelado
          
          // Formulario cambiar estado
          form#formCambiarEstado(class="space-y-4")
            input(type="hidden" name="_csrf" value=csrfToken)
            
            div
              label(for="nuevoEstado" class="block text-sm font-medium text-gray-700 mb-2") Cambiar a:
              select(id="nuevoEstado" name="estado" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-orange-500 focus:border-orange-500 text-sm")
                option(value="") Selecciona un estado
                each estado in estadosDisponibles
                  if estado.valor !== pedido.estado
                    option(value=estado.valor)= estado.label
            
            button(type="submit" class="w-full px-6 py-3 bg-orange-600 text-white font-semibold rounded-full hover:bg-orange-700 transition")
              | Actualizar Estado
        
        // Total
        div(class="bg-white rounded-xl shadow-md p-6 mt-6")
          h3(class="text-sm font-bold text-gray-700 uppercase tracking-wide mb-4") Resumen Financiero
          
          div(class="space-y-3 mb-4 pb-4 border-b border-gray-200")
            div(class="flex justify-between items-center text-sm")
              span(class="text-gray-600") Subtotal:
              span(class="font-medium text-gray-900") $#{Math.trunc(subtotal).toLocaleString('es-CO')}
          
          div(class="flex justify-between items-center")
            span(class="text-lg font-bold text-gray-900") Total:
            span(class="text-2xl font-bold text-orange-600") $#{Math.trunc(pedido.total).toLocaleString('es-CO')}

block scripts
  script.
    document.getElementById('formCambiarEstado').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nuevoEstado = document.getElementById('nuevoEstado').value;
      
      if (!nuevoEstado) {
        alert('Selecciona un estado');
        return;
      }
      
      try {
        const response = await fetch(`/admin/pedidos/#{pedido.id}/estado`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': document.querySelector('input[name="_csrf"]').value
          },
          body: JSON.stringify({ estado: nuevoEstado })
        });
        
        if (response.ok) {
          alert('Estado actualizado correctamente');
          location.reload();
        } else {
          const data = await response.json();
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error actualizando estado');
      }
    });


extends ../../layout/admin.pug

block content
  .container.my-5
    .row
      .col-md-8
        .card.mb-4
          .card-header.bg-primary.text-white
            h4.mb-0 Detalle del Pedido ##{pedido.id}
          .card-body
            .row.mb-4
              .col-md-6
                h6.text-muted CLIENTE
                p
                  strong= pedido.usuario.nombre
                  br
                  span= pedido.usuario.email
              .col-md-6
                h6.text-muted FECHA DEL PEDIDO
                p= new Date(pedido.fecha_creacion).toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })

            hr

            h6.text-muted DIRECCIÓN DE ENVÍO
            p= pedido.direccion_envio

            h6.text-muted MÉTODO DE PAGO
            p
              case pedido.metodo_pago
                when 'contra_entrega'
                  | Contra Entrega
                when 'tarjeta'
                  | Tarjeta de Crédito
                when 'transferencia'
                  | Transferencia Bancaria
                default
                  = pedido.metodo_pago

            hr

            h5.mt-4 Productos

            .table-responsive
              table.table
                thead.table-light
                  tr
                    th Producto
                    th Cantidad
                    th Precio Unitario
                    th Subtotal
                tbody
                  each item in pedido.pedido_items
                    tr
                      td
                        if item.Producto.imagen_principal
                          img(src=`/uploads/productos/${item.Producto.imagen_principal}`, alt=item.Producto.nombre, width="50")
                        span.ms-2= item.Producto.nombre
                      td
                        strong= item.cantidad
                      td $#{parseFloat(item.precio_unitario).toFixed(2)}
                      td
                        strong $#{parseFloat(item.subtotal).toFixed(2)}

      .col-md-4
        .card.mb-4
          .card-header.bg-secondary.text-white
            h5.mb-0 Cambiar Estado
          .card-body
            form#formCambiarEstado
              input(type="hidden", name="_csrf", value=csrfToken)
              
              .mb-3
                label.form-label Estado Actual
                .input-group
                  span.input-group-text
                    case pedido.estado
                      when 'pendiente'
                        span.badge.bg-warning Pendiente
                      when 'pagado'
                        span.badge.bg-info Pagado
                      when 'enviado'
                        span.badge.bg-success Enviado
                      when 'cancelado'
                        span.badge.bg-danger Cancelado

              .mb-3
                label.form-label(for="nuevoEstado") Nuevo Estado
                select.form-select(id="nuevoEstado", name="estado", required)
                  option(value="") Selecciona un estado
                  each estado in estadosDisponibles
                    if estado.valor !== pedido.estado
                      option(value=estado.valor)= estado.label

              button.btn.btn-primary.w-100(type="submit") Actualizar Estado

        .card
          .card-header.bg-light
            h6.mb-0 Información del Cambio
          .card-body
            if pedido.fecha_cambio_estado
              p.mb-2
                strong Última actualización:
                br
                = new Date(pedido.fecha_cambio_estado).toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })
              p
                strong Actualizado por:
                br
                | Admin
            else
              p.text-muted Sin cambios aún

    .mt-4
      a.btn.btn-secondary(href="/admin/pedidos") ← Volver a Pedidos

block scripts
  script.
    document.getElementById('formCambiarEstado').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const nuevoEstado = document.getElementById('nuevoEstado').value;
      
      if (!nuevoEstado) {
        alert('Selecciona un estado');
        return;
      }
      
      try {
        const response = await fetch(`/admin/pedidos/#{pedido.id}/estado`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'CSRF-Token': document.querySelector('input[name="_csrf"]').value
          },
          body: JSON.stringify({ estado: nuevoEstado })
        });
        
        if (response.ok) {
          alert('Estado actualizado correctamente');
          location.reload();
        } else {
          const data = await response.json();
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error actualizando estado');
      }
    });

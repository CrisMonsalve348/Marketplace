extends ../layout/app.pug

block content
  div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-12")
    h1(class="text-3xl font-bold text-gray-900 mb-8") Mi Carrito de Compras
    input(type="hidden" id="csrfToken" name="_csrf" value=csrfToken)
    
    if items.length > 0
      div(class="grid grid-cols-1 lg:grid-cols-3 gap-8")
        div(class="lg:col-span-2")
          div(class="bg-white rounded-xl shadow-md overflow-hidden")
            div(class="overflow-x-auto")
              table(class="w-full")
                thead(class="bg-orange-50 border-b-2 border-orange-200")
                  tr
                    th(class="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider") Producto
                    th(class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider") Precio
                    th(class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider") Cantidad
                    th(class="px-6 py-4 text-right text-xs font-bold text-gray-700 uppercase tracking-wider") Subtotal
                    th(class="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider") Acción
                tbody(class="divide-y divide-gray-200")
                  each item in items
                    tr(class="hover:bg-gray-50 transition")
                      if item.Producto
                        td(class="px-6 py-4")
                          div(class="flex items-center gap-4")
                            if item.Producto.imagen_principal
                              img(src=item.Producto.imagen_principal alt=item.Producto.nombre class="w-20 h-20 object-cover rounded-lg border border-gray-200")
                            else
                              div(class="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center border border-gray-200")
                                span(class="text-gray-400 text-xs") Sin imagen
                            div(class="flex-1 min-w-0")
                              h3(class="text-sm font-bold text-gray-900 mb-1")= item.Producto.nombre
                              p(class="text-xs text-gray-500") Stock: #{item.Producto.stock}
                        td(class="px-6 py-4 text-center")
                          p(class="text-lg font-bold text-orange-600") $#{Math.floor(item.precio_unitario).toLocaleString('es-CO')}
                        td(class="px-6 py-4 text-center")
                          input(type="number" min="1" max=item.Producto.stock value=item.cantidad data-item-id=item.id data-stock=item.Producto.stock data-cantidad=item.cantidad class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-orange-500 focus:border-orange-500")
                        td(class="px-6 py-4 text-right")
                          p(class="text-lg font-bold text-gray-900") $#{Math.floor(item.precio_unitario * item.cantidad).toLocaleString('es-CO')}
                        td(class="px-6 py-4 text-center")
                          button(class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition btn-eliminar font-medium text-sm" data-item-id=item.id type="button") Eliminar
                      else
                        td(colspan="5" class="px-6 py-4 text-center text-gray-500") Producto eliminado
        
        div(class="lg:col-span-1")
          div(class="bg-white rounded-xl shadow-md p-6 sticky top-6")
            h2(class="text-xl font-bold text-gray-900 mb-6") Resumen del pedido
            div(class="space-y-4 mb-6")
              div(class="flex justify-between items-center text-sm")
                span(class="text-gray-600") Productos:
                span(class="font-medium text-gray-900")= items.length
              div(class="flex justify-between items-center pt-4 border-t-2 border-orange-200")
                span(class="text-lg font-bold text-gray-900") Total:
                span(class="text-2xl font-bold text-orange-600") $#{Math.trunc(Number(total)).toLocaleString('es-CO')}
            div(class="space-y-3")
              a(href="/carrito/checkout" class="block w-full text-center px-6 py-3 bg-orange-600 text-white font-semibold rounded-full hover:bg-orange-700 transition shadow-md hover:shadow-lg")
                | Proceder al Pago
              a(href="/productos" class="block w-full text-center px-6 py-3 border-2 border-orange-300 text-orange-700 font-semibold rounded-full hover:bg-orange-50 transition")
                | Seguir Comprando

    else
      div(class="bg-white rounded-xl shadow-md p-12 text-center")
        div(class="max-w-md mx-auto")
          h2(class="text-2xl font-bold text-gray-900 mb-3") Tu carrito está vacío
          p(class="text-gray-600 mb-8") Descubre nuestros productos y encuentra lo que necesitas
          a(href="/productos" class="inline-block px-6 py-3 border border-orange-200 text-orange-700 font-semibold rounded-full hover:bg-orange-50 transition cursor-pointer") Ver Catálogo

  script.
    const csrfToken = document.getElementById('csrfToken')?.value || '';
    
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('change', async (e) => {
        const cantidad = parseInt(e.target.value);
        const itemId = e.target.dataset.itemId;
        const stock = parseInt(e.target.dataset.stock);
        
        if (cantidad < 1) {
          alert('La cantidad debe ser al menos 1');
          e.target.value = e.target.dataset.cantidad;
          return;
        }
        
        if (cantidad > stock) {
          alert(`Solo hay ${stock} unidades disponibles`);
          e.target.value = e.target.dataset.cantidad;
          return;
        }
        
        try {
          const response = await fetch('/carrito/actualizar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'CSRF-Token': csrfToken
            },
            body: JSON.stringify({ item_id: itemId, cantidad })
          });
          
          if (response.ok) {
            location.reload();
          } else {
            const data = await response.json();
            alert('Error: ' + data.error);
            e.target.value = e.target.dataset.cantidad;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error actualizando cantidad');
          e.target.value = e.target.dataset.cantidad;
        }
      });
    });
    
    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        if (!confirm('¿Deseas eliminar este producto del carrito?')) return;
        
        const itemId = e.currentTarget.dataset.itemId;
        
        try {
          const response = await fetch(`/carrito/${itemId}`, {
            method: 'DELETE',
            headers: {
              'CSRF-Token': csrfToken
            }
          });
          
          console.log('Response status:', response.status);
          
          if (response.ok) {
            location.reload();
          } else {
            console.error('Response not ok:', response.status);
            const data = await response.json();
            console.error('Error data:', data);
            alert('Error: ' + (data.error || 'No se pudo eliminar'));
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error eliminando producto');
        }
      });
    });
    // Actualizar cantidad
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('change', async (e) => {
        const cantidad = e.target.value;
        const itemId = e.target.dataset.itemId;
        
        try {
          const response = await fetch('/carrito/actualizar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'CSRF-Token': csrfToken
            },
            body: JSON.stringify({ item_id: itemId, cantidad })
          });
          
          if (response.ok) {
            location.reload();
          } else {
            const data = await response.json();
            alert('Error: ' + data.error);
            e.target.value = e.target.dataset.cantidad;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error actualizando cantidad');
        }
      });
    });
    
    // Eliminar item - DUPLICADO, NO USAR

extends ../layout/app.pug

block content
  div(class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6 mb-12")
    
    // Título
    h1(class="text-3xl font-bold text-gray-900 mb-8") Mi Carrito de Compras
    input(type="hidden" id="csrfToken" name="_csrf" value=csrfToken)
    
    if items.length > 0
      div(class="grid grid-cols-1 lg:grid-cols-3 gap-8")
        
        // Columna de items
        div(class="lg:col-span-2")
          div(class="space-y-4")
            each item in items
              if item.Producto
                div(class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition")
                  div(class="flex gap-6")
                    // Imagen
                    div(class="flex-shrink-0")
                      if item.Producto.imagen_principal
                        img(src=`/uploads/productos/${item.Producto.imagen_principal}` alt=item.Producto.nombre class="w-24 h-24 object-cover rounded-lg")
                      else
                        div(class="w-24 h-24 bg-gray-200 rounded-lg flex items-center justify-center")
                          svg(xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 text-gray-400")
                            path(d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z")
                    
                    // Información del producto
                    div(class="flex-1")
                    h3(class="text-lg font-bold text-gray-900 mb-2")= item.Producto.nombre
                    p(class="text-xl font-bold text-gray-900 mb-3") $#{Math.floor(item.precio_unitario).toLocaleString('es-CO')}
                    
                    div(class="flex items-center gap-4")
                      // Cantidad
                      div(class="flex items-center gap-2")
                        label(class="text-sm font-medium text-gray-700") Cantidad:
                        input(type="number" min="1" value=item.cantidad data-item-id=item.id data-stock=item.Producto.stock data-cantidad=item.cantidad class="w-20 px-3 py-2 border border-gray-300 rounded-full text-center focus:ring-orange-500 focus:border-orange-500 text-sm")
                      
                      // Subtotal
                      div(class="flex items-center gap-2")
                        span(class="text-sm font-medium text-gray-700") Subtotal:
                        span(class="text-lg font-bold text-gray-900") $#{Math.floor(item.precio_unitario * item.cantidad).toLocaleString('es-CO')}
                  
                  // Botón eliminar
                  div(class="flex-shrink-0")
                    button(class="p-2 text-red-600 hover:bg-red-50 rounded-full transition btn-eliminar" data-item-id=item.id type="button" title="Eliminar")
                      svg(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6")
                        path(stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12")
        
        // Columna de resumen
        div(class="lg:col-span-1")
          div(class="bg-white rounded-xl shadow-md p-6 sticky top-6")
            h2(class="text-xl font-bold text-gray-900 mb-6") Resumen del pedido
            
            // Subtotal
            div(class="flex justify-between items-center mb-3 pb-3 border-b border-gray-200")
              span(class="text-gray-700") Subtotal:
              span(class="text-lg font-semibold text-gray-900") $#{subtotal}
            
            // Total
            div(class="flex justify-between items-center mb-6")
              span(class="text-lg font-bold text-gray-900") Total:
              span(class="text-2xl font-bold text-orange-600") $#{total}
            
            // Botones
            div(class="space-y-3")
              a(href="/carrito/checkout" class="block w-full text-center px-6 py-3 bg-orange-600 text-white font-semibold rounded-full hover:bg-orange-700 transition")
                | Ir a Checkout
              a(href="/productos" class="block w-full text-center px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-full hover:bg-gray-50 transition")
                | Seguir Comprando

    else
      div(class="bg-white rounded-xl shadow-md p-12 text-center")
        svg(xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 mx-auto mb-6 text-gray-400")
          path(stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z")
        p(class="text-xl font-semibold text-gray-900 mb-3") Tu carrito está vacío
        p(class="text-gray-600 mb-6") Descubre nuestros productos y comienza a comprar
        a(href="/productos" class="inline-flex items-center px-6 py-3 bg-orange-600 text-white font-semibold rounded-full hover:bg-orange-700 transition")
          | Ir al catálogo

  script.
    const csrfToken = document.getElementById('csrfToken')?.value || '';

    // Actualizar cantidad
    document.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('change', async (e) => {
        const cantidad = e.target.value;
        const itemId = e.target.dataset.itemId;
        
        try {
          const response = await fetch('/carrito/actualizar', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'CSRF-Token': csrfToken
            },
            body: JSON.stringify({ item_id: itemId, cantidad })
          });
          
          if (response.ok) {
            location.reload();
          } else {
            const data = await response.json();
            alert('Error: ' + data.error);
            e.target.value = e.target.dataset.cantidad;
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error actualizando cantidad');
        }
      });
    });
    
    // Eliminar item
    document.querySelectorAll('.btn-eliminar').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        if (!confirm('¿Estás seguro?')) return;
        
        const itemId = e.currentTarget.dataset.itemId;
        
        try {
          const response = await fetch(`/carrito/${itemId}`, {
            method: 'DELETE',
            headers: {
              'CSRF-Token': csrfToken
            }
          });
          
          if (response.ok) {
            e.currentTarget.closest('tr').remove();
            location.reload();
          } else {
            alert('Error eliminando item');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Error eliminando item');
        }
      });
    });
